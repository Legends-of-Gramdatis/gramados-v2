{
    "ReturnToStart": 1b,
    "NpcInv": [
    ],
    "BossColor": 0,
    "PotionEffect": 0,
    "Size": 10,
    "stopAndInteract": 0b,
    "Resistances": {
        "Arrow": 2.0f,
        "Explosion": 2.0f,
        "Knockback": 2.0f,
        "Melee": 2.0f
    },
    "BossBar": 0b,
    "RespawnTime": 1,
    "NpcAngrySound": "",
    "ReactsToFire": 0b,
    "IgnoreCobweb": 0b,
    "PositionOffsetZ": 5.0f,
    "PositionOffsetY": 5.0f,
    "PositionOffsetX": 5.0f,
    "LootMode": 0,
    "TransformHasAI": 0b,
    "AttackStrenght": 0,
    "PersistenceRequired": 0b,
    "id": "customnpcs:customnpc",
    "IsStatue": 0b,
    "MovingPatern": 0,
    "NpcLines": {
        "Lines": [
        ]
    },
    "DefendFaction": 0b,
    "FireIndirect": 0,
    "NpcVisible": 0,
    "LinkedNpcName": "",
    "NpcScenes": {
        "Scenes": [
        ]
    },
    "HitSound": "minecraft:entity.arrow.hit",
    "FindShelter": 2,
    "Air": 300s,
    "TacticalVariant": 0,
    "Orientation": 0,
    "ScriptLanguage": "ECMAScript",
    "HandItems": [
        {
        },
        {
        }
    ],
    "KnockBack": 0,
    "TransformHasJob": 0b,
    "ArmorDropChances": [
        0.085f,
        0.085f,
        0.085f,
        0.085f
    ],
    "BurnInSun": 0b,
    "StandingState": 1,
    "AttackInvisible": 0b,
    "NpcInteractNPCLines": {
        "Lines": [
        ]
    },
    "HurtTime": 0s,
    "WalkingRange": 10,
    "ShotCount": 1,
    "pDur": 5,
    "AttackRange": 2,
    "NpcKillLines": {
        "Lines": [
        ]
    },
    "PotionImmune": 0b,
    "AvoidsSun": 0b,
    "Texture": "minecraft:textures/entity/slime/slime.png",
    "NpcJob": 0,
    "BurstCount": 1,
    "NpcAttackLines": {
        "Lines": [
        ]
    },
    "pSpeed": 10,
    "pArea": 0,
    "DeathTime": 0s,
    "pImpact": 0,
    "MoveState": 0,
    "pRender3D": 1b,
    "Motion": [
        0.0d,
        -0.0784000015258789d,
        0.0d
    ],
    "CombatRegen": 0,
    "NpcsTimers": [
    ],
    "MarkovGender": 0,
    "pEffect": 0,
    "DistanceToMelee": 0,
    "NpcStepSound": "",
    "FireRate": 5,
    "LeftHanded": 0b,
    "pEffAmp": 0,
    "OnGround": 1b,
    "Dimension": 0,
    "ImmuneToFire": 0b,
    "NpcKilledLines": {
        "Lines": [
        ]
    },
    "Fire": -1s,
    "ArmorItems": [
        {
        },
        {
        },
        {
        },
        {
        }
    ],
    "DisablePitch": 0b,
    "pPhysics": 1b,
    "TransformHasInv": 0b,
    "NpcInteractLines": {
        "Lines": [
        ]
    },
    "HurtByTimestamp": 47804,
    "pSpin": 0b,
    "NpcHurtSound": "minecraft:block.anvil.land",
    "pTrail": 0,
    "CreatureType": 0,
    "Attributes": [
        {
            "Base": 200.0d,
            "Name": "generic.maxHealth"
        },
        {
            "Base": 0.0d,
            "Name": "generic.knockbackResistance"
        },
        {
            "Base": 0.0d,
            "Name": "generic.movementSpeed"
        },
        {
            "Base": 0.0d,
            "Name": "generic.armor"
        },
        {
            "Base": 0.0d,
            "Name": "generic.armorToughness"
        },
        {
            "Base": 1.0d,
            "Name": "forge.swimSpeed"
        },
        {
            "Base": 32.0d,
            "Name": "generic.followRange"
        },
        {
            "Base": 0.0d,
            "Name": "generic.attackDamage"
        },
        {
            "Base": 0.0d,
            "Name": "generic.flyingSpeed"
        }
    ],
    "Invulnerable": 0b,
    "TransformHasDisplay": 0b,
    "NoFallDamage": 0b,
    "AbsorptionAmount": 0.0f,
    "TransformHasRole": 0b,
    "Name": "Bill Rack",
    "FallDistance": 0.0f,
    "SkinColor": 16777215,
    "NpcIdleSound": "",
    "Weapons": [
    ],
    "NPCDialogOptions": [
    ],
    "AggroRange": 1,
    "DirectLOS": 1b,
    "HealthRegen": 1,
    "ForgeCaps": {
        "fvtm:passenger": {
        }
    },
    "HandDropChances": [
        0.085f,
        0.085f
    ],
    "NpcModelData": {
        "LegsConfig": {
            "NotShared": 0b,
            "ScaleZ": 1.0f,
            "TransZ": 0.0f,
            "TransY": 0.0f,
            "TransX": 0.012000002f,
            "ScaleY": 1.0f,
            "ScaleX": 1.0f
        },
        "BodyConfig": {
            "NotShared": 0b,
            "ScaleZ": 1.0f,
            "TransZ": 0.0f,
            "TransY": 0.0f,
            "TransX": 0.0f,
            "ScaleY": 1.0f,
            "ScaleX": 1.0f
        },
        "Eyes": {
            "Pattern": 0b,
            "Glint": 1b,
            "Type": -1b,
            "PositionY": 1,
            "SkinColor": 11830381,
            "PlayerTexture": 0b,
            "Color": 6724056,
            "BrowColor": 5982516,
            "BrowThickness": 4
        },
        "EntityClass": "net.minecraft.entity.monster.EntitySlime",
        "LegParts": {
            "Pattern": 0b,
            "Type": 0b,
            "PlayerTexture": 0b,
            "Color": 16777215
        },
        "Parts": [
        ],
        "ArmsConfig": {
            "NotShared": 0b,
            "ScaleZ": 1.0f,
            "TransZ": 0.0f,
            "TransY": 0.0f,
            "TransX": -0.0f,
            "ScaleY": 1.0f,
            "ScaleX": 1.0f
        },
        "ExtraData": {
        },
        "HeadConfig": {
            "NotShared": 0b,
            "ScaleZ": 1.0f,
            "TransZ": 0.0f,
            "TransY": 0.0f,
            "TransX": 0.0f,
            "ScaleY": 1.0f,
            "ScaleX": 1.0f
        }
    },
    "minDelay": 20,
    "DoorInteract": 2,
    "MoveSpeed": 0,
    "TransformEditingModus": 0b,
    "UsingSkinUrl": 2b,
    "Leashed": 0b,
    "SkinUrl": "https://legends-of-gramdatis.com/gramados_skins/bank_safe/Gramados_slime_banksafe_billrack_4.png",
    "CanSwim": 1b,
    "GroundSound": "minecraft:block.stone.break",
    "MaxHealth": 200,
    "HideBodyWhenKilled": 0b,
    "AttackSpeed": 20,
    "PotionDuration": 5,
    "maxDelay": 40,
    "ScriptEnabled": 1b,
    "Role": 0,
    "DropChance": [
    ],
    "FactionPoints": {
        "DecreaseFaction1Points": 0b,
        "OptionFaction2Points": 100,
        "OptionFactions1": -1,
        "OptionFactions2": -1,
        "OptionFaction1Points": 100,
        "DecreaseFaction2Points": 0b
    },
    "pDamage": 4,
    "KilledTime": 0L,
    "AimWhileShooting": 0b,
    "CanPickUpLoot": 0b,
    "AttackOtherFactions": 0b,
    "CanDrown": 1b,
    "pSize": 5,
    "CanSprint": 0b,
    "CanLeap": 0b,
    "TransformIsActive": 0b,
    "ForgeData": {
        "cnpcmarkdata": {
            "marks": [
            ]
        },
        "CNPCStoredData": {
            "last_interraction": 2.496665652E9d,
            "safe_type": "Bill Rack",
            "fill_level": 4.0d
        }
    },
    "MovingState": 0,
    "MovingPos": 0,
    "PotionAmp": 0,
    "OnAttack": 0,
    "TacticalRadius": 8,
    "FallFlying": 0b,
    "MaxExp": 0,
    "OrderedLines": 0b,
    "PortalCooldown": 0,
    "pGlows": 0b,
    "TransformHasAdvanced": 0b,
    "TransformHasStats": 0b,
    "MovementType": 0,
    "FiringSound": "minecraft:entity.arrow.shoot",
    "ModRev": 18,
    "Accuracy": 60,
    "MinExp": 0,
    "Armor": [
    ],
    "CloakTexture": "",
    "GlowTexture": "",
    "MaxFiringRange": 15,
    "pXlr8": 0b,
    "MarkovGeneratorId": 1,
    "Scripts": [
        {
            "Script": "// Load utility modules
load(\"world/customnpcs/scripts/ecmascript/gramados_utils/utils_currency.js\");
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_files.js');
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_maths.js');
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_chat.js');
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_logging.js');
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_loot_tables.js')
load('world/customnpcs/scripts/ecmascript/gramados_utils/utils_loot_tables_paths.js')

load('world/customnpcs/scripts/ecmascript/modules/worldEvents/worldEventUtils.js');

var safe_type = [
    \"Gold Rack\",
    \"Bill Rack\",
    \"Safe\"
]
var click_cooldown = 60;
var regen_cooldown = 20000;

function init(event) {
    var npc = event.npc;

    if (!npc.getStoreddata().has(\"safe_type\") || !npc.getStoreddata().has(\"fill_level\")) {
        regenerate(npc);
    }
}

function tick(event) {
    var npc = event.npc;
    var fill_level = npc.getStoreddata().get(\"fill_level\");
    
    // if fill level is 0, then it's empty
    if (fill_level <= 0) {
        var current_time = npc.getWorld().getTotalTime();
        var last_interaction_time = npc.getStoreddata().get(\"last_interraction\");
        // check if the cooldown is over
        if (current_time - last_interaction_time >= regen_cooldown) { 
            // increase the fill level
            fill_level = Math.min(fill_level + 1, 4);
            npc.getStoreddata().put(\"fill_level\", fill_level);
            saveInteractionTime(npc);
            updateSkinURL(npc);
        }
    }
}

function interact(event) {
    var npc = event.npc;

    // get player hand item
    var player = event.player;
    var item = player.getMainhandItem();
    var item_name = item.getName();
    var fill_level = npc.getStoreddata().get(\"fill_level\");

    // If player uses a command block to interact with the NPC
    if (item_name == \"minecraft:command_block\") {
        npc.executeCommand(\"/playsound ivv:computer.gaming.deleted player @a\");
        var new_type = regenerate(npc);

        tellPlayer(player, \"&6The rack has been regenerated to: &l\" + new_type);
    } else if (fill_level > 0) {

        if (getTimer(npc) > click_cooldown) {
            npc.executeCommand(\"/playsound minecraft:block.shulker_box.open block @a\");
            // tellPlayer(player, \"&6You have successfully opened the rack!\");
            loot_safe(event);
        } else {
            // tellPlayer(player, \"&6Cooldown: \" + click_cooldown + \" ticks\");
            // tellPlayer(player, \"&6Fill Level: \" + npc.getStoreddata().get(\"fill_level\"));
            // tellPlayer(player, \"&6Current Type: \" + npc.getStoreddata().get(\"safe_type\"));
            npc.executeCommand(\"/playsound minecraft:block.anvil.hit block @a\");
        }
    } else {
        // tellPlayer(player, \"&6The rack is empty!\");
        npc.executeCommand(\"/playsound chisel:block.metal.hit block @a\");
    }
}

function regenerate(npc) {
    var current_type = npc.getStoreddata().get(\"safe_type\");
    var current_index = safe_type.indexOf(current_type);
    var next_index = (current_index + 1) % safe_type.length;
    var next_type = safe_type[next_index];
    npc.getDisplay().setName(next_type);

    npc.getStoreddata().put(\"safe_type\", next_type);
    npc.getStoreddata().put(\"fill_level\", 4);

    saveInteractionTime(npc);

    updateSkinURL(npc);

    return next_type;
}

function saveInteractionTime(npc) {
    var current_time = npc.getWorld().getTotalTime();
    npc.getStoreddata().put(\"last_interraction\", current_time);
}

function loot_safe(event) {
    var npc = event.npc;
    var player = event.player;

    var fill_level = npc.getStoreddata().get(\"fill_level\");

    fill_level = Math.max(0, fill_level - 1);
    npc.getStoreddata().put(\"fill_level\", fill_level);
    saveInteractionTime(npc);

    updateSkinURL(npc);
    generateLoot(npc.getWorld(), npc, player);
}

function getTimer(npc) {
    var current_time = npc.getWorld().getTotalTime();
    var last_interaction_time = npc.getStoreddata().get(\"last_interraction\");
    if (last_interaction_time == null) {
        return 0;
    }
    var elapsed_time = current_time - last_interaction_time;
    return elapsed_time;
}

function generateLoot(world, npc, player) {
    var full_loot = [];

    switch (npc.getStoreddata().get(\"safe_type\")) {
        case \"Gold Rack\":
            var full_loot = pullLootTable(_LOOTTABLE_BANKVAULT_GOLDRACK, player);
            for (var i = 0; i < full_loot.length; i++) {
                player.giveItem(
                    generateItemStackFromLootEntry(full_loot[i], world, player)
                );
            }
            break;
        case \"Bill Rack\":
            var money = rrandom_range(10000, 500000);
            var moneyItems = generateMoney(world, money);
            for (var i = 0; i < moneyItems.length; i++) {
                player.dropItem(moneyItems[i]);
            }
            break;
        case \"Safe\":
            var full_loot = pullLootTable(_LOOTTABLE_BANKVAULT_SAFE, player);
            for (var i = 0; i < full_loot.length; i++) {
                player.giveItem(
                    generateItemStackFromLootEntry(full_loot[i], world, player)
                );
            }
            break;
    }
}

function updateSkinURL(npc) {
    var current_type = npc.getStoreddata().get(\"safe_type\");
    var fill_level = npc.getStoreddata().get(\"fill_level\");

    var skin_url = \"https://legends-of-gramdatis.com/gramados_skins/bank_safe/Gramados_slime_banksafe_\";

    switch (current_type) {
        case \"Gold Rack\":
            skin_url = skin_url + \"goldrack_\" + fill_level + \".png\";
            break;
        case \"Bill Rack\":
            skin_url = skin_url + \"billrack_\" + fill_level + \".png\";
            break;
        case \"Safe\":
            skin_url = skin_url + \"safe_\" + fill_level + \".png\";
            break;
    }

    npc.getDisplay().setSkinUrl(skin_url);
}",
            "Console": [
            ],
            "ScriptList": [
            ]
        }
    ],
    "Health": 200.0f,
    "pStick": 0b,
    "MovingPause": 1b,
    "NpcDeathSound": "minecraft:entity.player.hurt",
    "FactionID": 16,
    "Title": "",
    "TotalTicksAlive": 236441L,
    "Rotation": [
        0.0f,
        0.0f
    ],
    "ShowName": 1,
    "npcInteracting": 1b,
    "UpdateBlocked": 0b,
    "AvoidsWater": 0b,
    "NoLivingAnimation": 1b,
    "SpawnCycle": 0
}
