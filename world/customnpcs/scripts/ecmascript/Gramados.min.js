//==Reallife date handler for hiring regions etc
var msTable = {
	'y': 31556926000,
	'mon': 2629743830,
	'w': 604800000,
	'd': 86400000,
	'h': 3600000,
	'min': 60000,
	's': 1000,
	'ms': 1
};

Date.prototype.addTime = function(addTime) {
	this.setTime(this.getTime()+addTime);
};

Date.prototype.hasPassed = function(passDate) {
	return (this.getTime() >= passDate.getTime());
}

//Converts TimeString to number
function getStringTime(timeString) {
	//0y4mon3d 6h 8min3s 800ms
	var reg = /([\d]+)([a-zA-Z]+)/g;
	var _m = timeString.match(reg);
	var newTime = 0;
	var _tk = Object.keys(msTable);
	
	for(m in _m) {
		var fm = _m[m];
		var nm = fm.replace(reg, '$1').cInt();
		var om = fm.replace(reg, '$2');
		if(nm != null) {
			if(_tk.indexOf(om) != -1) {
				newTime += nm * (msTable[_tk[_tk.indexOf(om)]]);
			} else { newTime += nm; }
		}
	}
	
	return newTime;
}
//Converts number to TimeString
function getTimeString(stringTime, excludes) {
	if(typeof(excludes) == typeof(undefined)) { var excludes = []; }
	var newTime = parseInt(stringTime);
	var newStr = '';
	for(ms in msTable) {
		if(excludes.indexOf(ms) == -1) {
			var msnum = 0;
			while(newTime >= msTable[ms]) {
				msnum++;
				newTime -= msTable[ms];
			}
			if(msnum > 0) {
				newStr += msnum.toString()+ms;
			}
		}
	}
	
	
	return newStr;
}String.prototype.allMatch = function(regx) {
	var m = this.match(regx);
	var rr = [];
	for(mm in m) {
		var mt = m[mm];
		var rx = regx.exec(this);
		rr.push(rx);
	}
	
	return rr;
};


String.prototype.cmatch = function(regx) {
	return (this.match(regx) || []).length;
}

String.prototype.rangeUpper = function(min, max) {
	var str = '';
	for(var i = 0; i < this.length; i++) {
		var c = this.substring(i, i+1); //curchar
		if(i >= min && i < max) {
			c=c.toUpperCase();
		}
		str+=c.toString();
	}
	return str;
}

String.prototype.pad = function(character, len) {
	var n = this.toString();
	for(i = n.length; i < len; i++) {
		n += character.toString();
	}
	return n;
}

String.prototype.padMiddle = function(character, len) {
	
	var n = this.toString();
	var sc = Math.floor((len-n.length)/2);
	var ns = '';
	for(i = 0; i < sc; i++) {
		ns += character.toString();
	}
	ns+=n;
	for(i = 0; i < sc; i++) {
		ns += character.toString();
	}
	return ns;
}

String.prototype.cInt = function() {
	return (isNaN(parseInt(this)) ? null : parseInt(this));
}

String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

String.prototype.append = function(ch, amount) {
	var new_str = this.toString();
  	for(var i = 0; i < amount; i++) {
    	if(i >= new_str.length) {
        	new_str += ch.toString();
        }
    }
  
  return new_str;
}
String.prototype.prepend = function(ch, amount) {
	var new_str = this.toString();
  	for(var i = 0; i < amount; i++) {
    	if(i >= new_str.length) {
        	new_str = ch.toString()+new_str;
        }
    }
  
  return new_str;
}

var ASSET_MOD_ID = "adventureassets";

function objMerge(obj1,obj2){
    var obj3 = {};
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname]; }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname]; }
    return obj3;
}

function getHalfRotation(angle) {
	angle = fixAngle(angle);
	if(angle <= 180) { return angle; } else { return -(180-(angle-180)); }
}

function getQuartRotation(dir) {
	dir = getHalfRotation(dir);
	
	if(Math.abs(dir) > 90) {
		dir = (180-Math.abs(dir))*sign(dir);
	}
	
	return dir;
}

function playerIsOnline(world, player) {
	var isOnline = false;
	var pl = world.getAllPlayers();
	for(p in pl) {
		if(pl[p].getName() == player.toString()) {
			isOnline = true;
			break;
		}
	}
	return isOnline;
}

function getHandItem(player) {
	return player.getMainhandItem() || player.getOffhandItem();
}
function uniqid() {
	var id = '';
	for(var i = 0; i <= 3; i++) {
		id+=Math.random().toString(36).substr(2, 9);
	}
	return id;
}

function occurrences(string, subString, allowOverlapping) {
	if(typeof(allowOverlapping) == typeof(undefined)) { var allowOverlapping = false; }
    string += "";
    subString += "";
	
    if (subString.length <= 0) return (string.length + 1);

    var n = 0,
        pos = 0,
        step = allowOverlapping ? 1 : subString.length;

    while (true) {
        pos = string.indexOf(subString, pos);
        if (pos >= 0) {
            ++n;
            pos += step;
        } else break;
    }
    return n;
}

function arrayTakeRange(arr, start, end) {
	if(typeof(end) == typeof(undefined)) { var end = null; }
	if(end == null) { end = arr.length; }
	var a = [];
	var _end = Math.min(end, arr.length);
	var _start = Math.min(start, _end);
	for(var i = _start; i < Math.min(end, arr.length); i++) {
		if(typeof(arr[i]) != typeof(undefined)) {
			a.push(arr[i]);
		}
	}
	return a;
}


function sign(num) {
	if(typeof(num) == typeof(undefined)) { var num = 0; }
	if(num > 0) { return 1; }
	if(num < 0) { return -1; }
	return 0;
}

function g(obj, grp_props) {
	for(j in grp_props) {
		var props = grp_props[j];
		for(i in props[0]) {
			if(obj != null) {
				if(typeof(obj[props[0][i]]) != typeof(undefined)) {
					obj = obj[props[0][i]];
					
					break;
				}
			}
		}
	}
	
	
	return obj;
}

function getAllFuncs(obj) {
    var props = [];

    do {
        props = props.concat(Object.getOwnPropertyNames(obj));
    } while (obj = Object.getPrototypeOf(obj));

    return props.sort().filter(function(e, i, arr) { 
       if (e!=arr[i+1] && typeof obj[e] == 'function') return true;
    });
}

function removeFromArray(arr, vals) {
	if(typeof(vals) == 'string') { vals = [vals]; }
	var a = [];
	arr.forEach(function(el){a.push(el);});//Copy array
	for(v in vals) {
		var i = arr.indexOf(vals[v]);
		if(i > -1) {
			a.splice(i, 1);
		}
	}
	
	return a;
}

var _RAWCOLORS = {
	'0': 'black',
	'1': 'dark_blue',
	'2': 'dark_green',
	'3': 'dark_aqua',
	'4': 'dark_red',
	'5': 'dark_purple',
	'6': 'gold',
	'7': 'gray',
	'8': 'dark_gray',
	'9': 'blue',
	'a': 'green',
	'b': 'aqua',
	'c': 'red',
	'd': 'light_purple',
	'e': 'yellow',
	'f': 'white',
};

var _RAWEFFECTS = {
	'o': 'italic',
	'l': 'bold',
	'k': 'magic',
	'm': 'strike',
	'n': 'underline',
	'r': 'reset'
}
function getColorId(name) {
	for(i in _RAWCOLORS) {
		if(name == _RAWCOLORS[i]) {
			return i;
		}
	}
	for(i in _RAWEFFECTS) {
var re = _RAWEFFECTS[i];
		if(name == re) {
			return i;
		}
	}
	return 'r';
}

function strf(str, toRaw) {
	if(typeof(toRaw) == typeof(undefined)) { var toRaw = false; }
	return strrawformat(str, toRaw);
}

function strrawformat(str, toRaw) {
	if(typeof(toRaw) == typeof(undefined)) { var toRaw = false; }
	var rf = [];
	var txt = '';
	var ri = -1;
	var isCode = false;
	var txtColor = 'white';
	var isItalic = 0;
	var isBold = 0;
	var isStrike = 0;
	var isUnderlined = 0;
	var isObf = 0;
	str = str+'&r ';
	
	for(var i = 0; i < str.length; i++) {
		var c = str.substr(i, 1);
		if(c == '&' || i == str.length-1) {
			//Check if new section has to be made
			if(txt.length > 0) {
				ri++;
				var cmds = [];
				
				rf.push([txt, txtColor, isItalic, isBold, isUnderlined, isStrike, isObf]);
				isItalic = false;
				isBold = false;
				isUnderlined = false;
				isStrike = false;
				isObf = false;
				txtColor = 'white';
				txt = '';
			}
			isCode = true;
			continue;
		} else {
			if(!isCode) {
				txt += c.toString();
			} else {
				//Check Colors
				if(typeof(_RAWCOLORS[c]) != typeof(undefined)) {
					txtColor = _RAWCOLORS[c];
				}
				//Check Markup
				switch(c.toString()) {
					case 'o': {
						isItalic = true;
						break;
					}
					case 'l': {
						isBold = true;
						break;
					}
					case 'n': {
						isUnderlined = true;
						break;
					}
					case 'm': {
						isStrike = true;
						break;
					}
					case 'k': {
						isObf = true;
						break;
					}
					case 'r': {
						isItalic = false;
						isBold = false;
						isUnderlined = false;
						isStrike = false;
						isObf = false;
						txtColor = 'white';
						break;
					}
				}
				isCode = false;
			}
		}
	}
	
	return (!toRaw ? rf : rawformat(rf));
}


function rawformat(str_pieces, fullraw) {
	if(typeof(fullraw) == typeof(undefined)) { var fullraw = true; }
	//print("FULLRAR: "+fullraw.toString());
	var txt = '';
	if(fullraw) { txt+='[""'; }
	var trg = /{[\s]*([\w]+)[\s]*\;[\s]*([\w\W.:\/]+)[\s]*}/;
	for(i in str_pieces) {
		var p = str_pieces[i];
		var ntext = p[0].replace(/\"/g, '\\"');
		var nm =  ntext.match(trg) || [];
		if(nm.length > 0) {
			p[7] = nm[1];
			p[8] = nm[2];
			ntext = ntext.replace(nm[0], '');
		}
		var pc = '{"text":"'+ntext+'"';
		if(p[1]) { pc+=',"color":"'+p[1].toString()+'"'; }
		if(p[2]) { pc+=',"italic":true'; }
		if(p[3]) { pc+=',"bold":true'; }
		if(p[4]) { pc+=',"underlined":true'; }
		if(p[5]) { pc+=',"strikethrough":true'; }
		if(p[6]) { pc+=',"obfuscated":true'; }
		if(p[7]) { pc+=',"clickEvent":{"action":"'+p[7]+'","value":"'+p[8]+'"}'; }
		pc += '}';

		
		txt+=','+pc.toString();
	}
	
	if(fullraw) {
		txt += ']';
	}
	return txt;
	

}

function data_get(data, keys) {
	var get = {};
	for(k in keys) {
		//var key = keys[k];
		get[k] = data.get(k);
		if(get[k] == null) { get[k] = keys[k]; }
	}
	
	return get;
}

function data_register(data, vals) {
	for(k in vals) {
		var val = vals[k];
		if(data.get(k) == null) { data.put(k, val); }
	}
}

function clone(obj) {
    var copy;

    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;

    // Handle Date
    if (obj instanceof Date) {
        copy = new Date();
        copy.setTime(obj.getTime());
        return copy;
    }

    // Handle Array
    if (obj instanceof Array) {
        copy = [];
        for (var i = 0, len = obj.length; i < len; i++) {
            copy[i] = clone(obj[i]);
        }
        return copy;
    }

    // Handle Object
    if (obj instanceof Object) {
        copy = {};
        for (var attr in obj) {
            if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
        }
        return copy;
    }

    throw new Error("Unable to copy obj! Its type isn't supported.");
}

function data_overwrite(data, keys, vals) {
	if(typeof(keys) == typeof(undefined)) { var keys = []; }
	if(typeof(vals) == typeof(undefined)) { var vals = []; }
	if(typeof(keys) == 'string') { keys = [keys]; }
	if(typeof(vals) == 'string') { vals = [vals]; }
	
	for(k in keys) {
		var key = keys[k];
		var val = vals[k];
		data.put(key, val);
	}
}

function posdir(pos, dir, pitch, len, flying) {
	if(typeof(dir) == typeof(undefined)) { var dir = 0; }
	if(typeof(pitch) == typeof(undefined)) { var pitch = 0; }
	if(typeof(len) == typeof(undefined)) { var len = 1; }
	if(typeof(flying) == typeof(undefined)) { var flying = false; }
	var x = pos.getX();
	var y = pos.getY();
	var z = pos.getZ();
	var xdir = getQuartRotation(dir);
	var zdir = getQuartRotation(dir-90);
	x += Math.round(len*(Math.abs(xdir)/90)*sign(xdir));
	z += Math.round(len*(Math.abs(zdir)/90)*sign(zdir));
	if(flying) {
		y += (len)*(Math.abs(pitch)/90)*-sign(pitch);
	}
	return {x:x,y:y,z:z};
}


function fixAngle(angle) {
	angle = Math.abs(angle);
	if(angle >= 360) { angle -= 360; }
	return angle;
}

function lengthpitch_y(pitch, length) {
	return Math.round(pitch/-90)*length;
}


function lengthdir_x(angle, length) {
	if(typeof(length) == typeof(undefined)) { var length = 1; }
	return Math.round((getQuartRotation(angle)/90)*length);
}

function lengthdir_z(angle, length) {
	if(typeof(length) == typeof(undefined)) { var length = 1; }
	angle = fixAngle(angle+270);
	return -lengthdir_x(angle, length);
}

function pick(a, amount) {
	if(typeof(amount) == typeof(undefined)) { var amount = 1; }
	var index = Math.floor(Math.random() * a.length);
	amount = Math.min(a.length, amount);
	if(amount == 1) {
		return a[index];
	} else {
		var picks = [];
		
		while(picks.length < amount) {
			index = Math.floor(Math.random() * a.length);
			if(picks.indexOf(a[index]) == -1) { picks.push(a[index]); }
		}
		
		return picks;
	}
}

function escapeNbtJson(json, trim_ends) {
	if(typeof(trim_ends) == typeof(undefined)) { var trim_ends = true; }
	json = json.replace(/(?:\\n|\\)/g, '');
	json = json.replace(/(\d) ([fbds]+)/g, "$1$2");
	json = json.replace(/\\("|')/g, "$1");
	if(trim_ends) {
		json = json.slice(1, json.length - 1);
	}
	
	return json;
}


function array_remove(array, element) {
  var index = array.indexOf(element);

  if (index !== -1) {
    array.splice(index, 1);
  }
}

function pickwhere(a, fn, amount) {
	return pick(array_filter(a, fn), amount);
}

function array_dist(a) {
	var b = [];
	for(c in a) {
		if(b.indexOf(a[c]) == -1) {
			b.push(a[c]);
		}
	}
	
	return b;
}

function objArray(obj) {
	var a = [];
	for(i in obj) {
var o = obj[i];
		a.push(o);
	}
	return a;
}

function array_filter(a, fn) {
	var aa = [];
	for(i in a) {
		if(fn(a[i])) { aa.push(a[i]); }
	}
	
	return aa;
}

function escCcs(str, esc_formats) {
	if(typeof(esc_formats) == typeof(undefined)) { var esc_formats = null; }
	if(esc_formats == null) {
		esc_formats = Object.keys(_RAWCOLORS).concat(Object.keys(_RAWEFFECTS));
	}
	
	return str.replace(new RegExp('&(['+esc_formats.join("")+'])', 'g'), '');
}

function ccs(str, af) {
	if(typeof(af) == typeof(undefined)) { var af = null; }
	return colorCodeString(str, af);
}

function colorCodeString(str, allowed_formats) {
	if(typeof(allowed_formats) == typeof(undefined)) { var allowed_formats = null; }
	if(allowed_formats == null) {
		allowed_formats = Object.keys(_RAWCOLORS).concat(Object.keys(_RAWEFFECTS));
	}
	
	return str.replace(new RegExp("&(["+allowed_formats.join("")+"])", 'g'), '\u00A7$1').replace(/&\\/g, '&');
}

function genName(name) {
	var p = [
    'Amazing',
    'Awesome',
    'Blithesome',
    'Excellent',
    'Fabulous',
    'Fantastic',
    'Favorable',
    'Gorgeous',
    'Incredible',
    'Outstanding',
    'Perfect',
    'Propitious',
    'Remarkable',
    'Rousing',
    'Spectacular',
    'Splendid',
    'Stellar',
    'Super',
    'Upbeat',
    'Unbelievable',
    'Wondrous',
	'Tempered',
	'Legendary',
	'Magical'
	];
	var s = [
		'Destruction',
		'Slaughter',
		'Starlight',
		'Heroism',
		'Bonebreaking',
		'The Fallen',
		'Silence',
		'Spellkeeping',
		'Massacre',
		'Sanity',
		'Insanity',
		'Remorse',
		'Fury'
	];
	
	return pick(p) + ' ' + name + ' of ' + pick(s);
}

function nbtCopy(nbt, api) {
	return api.stringToNbt(nbt.toJsonString());
}

function getDayTime(time) {
	while(time > 24000) { time -= 24000; }
	return time;
}

function random_ranges(min, max, amount) {
	var a = 0;
	for(var i = 0; i < amount; i++) { a += random_range(min, max); }
	return a;
}

function rrandom_ranges(min, max, amount) {
	var a = 0;
	for(var i = 0; i < amount; i++) { a += rrandom_range(min, max); }
	return a;
}

function pickchance(a, amount) {
	var aa = [];
	for(e in a) {
		if(!isArray(a[e])) {
			aa[aa.length] = a[e];
		} else {
			for(var i = 0; i < a[e][1]; i++) {
				aa[aa.length] = a[e][0];
			}
		}
	}
	
	return pick(aa, amount);
}

function inArray(a, val) {
	for(k in a) { if(a[k] === val) { return true; } }
	return false
}

function rrandom_range(min, max) { return Math.round(random_range(min, max)); }

function random_range(_min, _max) {
	var min = Math.min(_min, _max);
	var max = Math.max(_min, _max);
	
	var diff = max - min;
	
	return (min + (Math.random() * diff));
}

function array_merge(a1, a2) {
	var bb = [];
	for(k in a1) {
		bb[k] = a1[k];
	}
	for(k in a2) {
		bb[k] = a2[k];
	}
	return bb;
}

function isArray(obj) {
	if(typeof(obj) === 'object') {
      for(k in obj) {
      
          if(isNaN(k)) { return false; }
      }
      

      return true;
    } else { return false }
}

function isObject(obj) {
	return ( typeof(obj) === 'object' && !isArray(obj) );
}


function nbtItem(nbt, w, api) {
	if(typeof(nbt) == 'string') { nbt = api.stringToNbt(nbt); }
	var item = w.createItemFromNbt(nbt);
	
	return item;
}
function executeCommand(player, command, as_player) {
	if(typeof(as_player) == typeof(undefined)) { var as_player = null; }
	if(as_player == null) { as_player = player.getName(); }
	var API = Java.type('noppes.npcs.api.NpcAPI').Instance();
	var cmd = API.createNPC(player.world.getMCWorld());
	
	return cmd.executeCommand("/execute "+as_player+" ~ ~ ~ "+command);
	
}
function tellPlayer(player, rawtext) {
	if(typeof(rawtext) == 'string') { var rawtext = strf(rawtext); }
	
	return executeCommand(player, "/tellraw "+player.getName()+" "+rawformat(rawtext));
}

function tellPlayerStr(player, text) {
	return executeCommand(player, "/tellraw "+player.getName()+" "+text.toString());
}

function storytellPlayer(player, ar) {
	for(i in ar) {
		//print(ai[i].join('==='));
		tellPlayer(player, ar[i]);
	}
}

/*
function storyte_llPlayer(player, array_rawtext) {
	var tellStr = '[""';
	for(i in array_rawtext) {
		if(tellStr.substr(tellStr.length-1, tellStr.length) != ',' && tellStr.length > 0) {
			tellStr += ',';
		}
		tellStr += rawformat(array_rawtext[i], false).toString();
		if(i < array_rawtext.length-1) {
			tellStr += ',{"text":"\n"}';
		}
	}
	tellStr += ']';
	print(tellStr);
	return tellPlayerStr(player, tellStr);
}*/
var _COMMANDS = [];
function chatChannel(name) {
	this.name = name;
	this.data = {
		"name": name,
		"players": [],
	};
	this.save = function(data) {
		
	}
}




function Job(name) {
	this.name = name;
	this.jobdata = {
		"displayName": name,
		"pay": getCoinAmount('5g'),
		"payTime": getStringTime('20min'),
		"isOpen": false,
		"capacity": 10,
		"fireTime": getStringTime('1w')
	};
	this.save = function(data) {
		data.put('job_'+this.name, JSON.stringify(this.jobdata));
		return this;
	};
	this.exists = function(data) {
		return (data.get('job_'+this.name) != null);
	};
	this.load = function(data) {
		if(this.exists(data)) {
			this.jobdata = objMerge(this.jobdata, JSON.parse(data.get('job_'+this.name)));
			return true;
		}
		return false;
	};
	this.getPlayers = function(data) {
		var pl = [];
		var dkeys = data.getKeys();
		for(d in dkeys) {
var dkey = dkeys[d];
			if(dkey.cmatch(/player_(\w+)/g) == 1) {
				var player = new Player(dkey.replace(/player_(\w+)/g, '$1'));
				player.load(data);
				if(player.hasJob(this.name) && pl.indexOf(player.name) == -1) {
					pl.push(player.name);
				}
			}
		}
		
		return pl;
	}
	this.remove = function(data) {
		data.remove('job_'+this.name);
		return this;
	};
	this.getDisplayName = function() {
		return this.jobdata.displayName+'&r';
	}
	this.toJson = function() {
		return JSON.stringify(this.jobdata);
	};
	this.getStatusColor = function(data) {
		if(this.jobdata.capacity == -1) {
			return '&a';
		}
		if(this.getPlayers(data).length < this.jobdata.capacity) {
			return '&6';
		}
		return '&c';
	};
}

var PERMISSION_REGEX = /permission_([\w.-]+)/;
function getAllPermissionIds(data) {
	var dk = data.getKeys();
	var ids = [];
	for(d in dk) {
var dkey = dk[d];
		if(dkey.cmatch(PERMISSION_REGEX) > 0) {
			var perm_id = dkey.replace(PERMISSION_REGEX, '$1');
			ids.push(perm_id);
		}
	}
	
	return ids;
}

function getParentPermissionIds(data, permId) {
	var pIds = [];
	var idArr = permId.split(".");
	var tid = this.id;
	getAllPermissionIds(data).forEach(function(pId){
		var pIdArr = pId.split(".");
		var isPar = true;
		for(i in pIdArr) {
var _p = pIdArr[i];
			if(_p != idArr[i]) {
				isPar = false;
			}
		}
		
		if(isPar && pIds.indexOf(pId) == -1 && pId != tid) {
			pIds.push(pId);
		}
	});
	
	return pIds;
};

function Permission(id) {
	this.id = id;
	this.permdata = {
		"enabled": true,
		"teams": [
			"Owner",
			"Developer"
		],
		"players": [],
		"meta": {}
	};
	this.remove = function(data) {
		if(this.exists(data)) {
			data.remove('permission_'+this.id);
			return true;
		}
		return false;
	}
	this.save = function(data) {
		data.put('permission_'+this.id, JSON.stringify(this.permdata));
		return this;
	};
	this.exists = function(data) {
		return (data.get('permission_'+this.id) != null);
	};
	this.addTeams = function(teams) {
		if(typeof(teams) == 'string') { teams = [teams]; }
		for(t in teams) {
var team = teams[t];
			var teamname = team;
			if(this.permdata.teams.indexOf(teamname) == -1) {
				this.permdata.teams.push(teamname);
			}
		}
		
		return this;
	};
	this.removeTeams = function(teams) {
		if(typeof(teams) == 'string') { teams = [teams]; }

		var nteams = [];
		for(t in this.permdata.teams) {
var team = this.permdata.teams[t];
			if(teams.indexOf(team) == -1) {
				nteams.push(team);
			}
		}
		this.permdata.teams = nteams;
		return this;
	};
	this.toJson = function() {
		return JSON.stringify(this.permdata);
	};
	this.addPlayers = function(players) {
		if(typeof(players) == 'string') { players = [players]; }
		for(p in players) {
var player = players[p];
			if(this.permdata.players.indexOf(player) == -1) {
				this.permdata.players.push(player);
			}
		}
		
		return this;
	};
	this.removePlayers = function(players) {
		if(typeof(players) == 'string') { players = [players]; }
		var nplayers = [];
		for(p in this.permdata.players) {
var player = this.permdata.players[p];
			if(players.indexOf(player) == -1) {
				nplayers.push(player);
			}
		}
		this.permdata.players = nplayers;
		return this;
	}
	this.load = function(data) {
		var ndata = data.get('permission_'+this.id);
		if(ndata != null) {
			this.permdata = objMerge(this.permdata, JSON.parse(ndata));
			return true;
		}
		return false;
	};
	this.permits = function(player, sb, data) {
		var team = sb.getPlayerTeam(player);
		var permitted = false;
		if(!this.permdata.enabled) { return true; }
		if(team != null) {
			if(this.permdata.teams.indexOf(team.getDisplayName()) != -1) {
				permitted = true;
			}
		}
		
		if(this.permdata.players.indexOf(player) != -1) {
			permitted = true;
		}
		
		
		return permitted;
	};
	
	return this;
}


function Player(name) {
	this.name = name;
	this.playerdata = {
		"lastPayed": 0,
		"pay": getCoinAmount('5g'),
		"payTime": getStringTime('20min'),
		"maxJobs": 2,
		"maxHomes": 1,
		"homes": {},
		"jobs": {},
		"chatcolor": "white",
		"firstLogin": new Date().getTime(),
		"lastLogin": 0
	};
	
	this.load = function(data) {
		if(this.exists(data)) {
			this.playerdata = objMerge(this.playerdata, JSON.parse(data.get('player_'+this.name)));
			return true;
		}
		return false;
	};
	this.exists = function(data) {
		return (data.get('player_'+this.name) != null);
	};
	this.save = function(data) {
		data.put('player_'+this.name, JSON.stringify(this.playerdata));
		return this;
	};
	this.delJob = function(name) {
		if(this.hasJob(name)) {
			delete this.playerdata.jobs[name];
		}
		return this;
	};
	this.getJob = function(name) {
		if(this.hasJob(name)) {
			return this.playerdata.jobs[name];
		}
		return null;
	};
	this.getJobs = function() {
		return this.playerdata.jobs;
	};
	this.getJobCount = function() {
		return Object.keys(this.playerdaya.jobs).length;
	};
	this.addJob = function(name) {
		this.playerdata.jobs[name] = {
			"lastPayed": 0
		};
		return this;
	};
	this.hasJob = function(name) {
		return Object.keys(this.playerdata.jobs).indexOf(name) > -1;
	};
	this.hasMaxJobs = function() {
		return (this.playerdata.maxJobs != -1 && this.getJobCount() >= this.playerdata.maxJobs);
	};
	this.addHome = function(name, x, y, z) {
		this.playerdata.homes[name] = {
			x: x,
			y: y,
			z: z,
		};
		return this;
	};
	this.delHome = function(name) {
		if(this.playerdata.homes.hasOwnProperty(name)) {
			delete this.playerdata.homes[name];
		}
		return this;
	};
	this.hasHome = function(name) {
		return (this.playerdata.homes.hasOwnProperty(name));
	};
	this.toJson = function() {
		return JSON.stringify(this.playerdata);
	};

}





function Region(name) {
	this.name = name;
	this.regiondata = {
		"displayName": this.name,
		"positions": [],
		"owner": null,
		"salePrice": getCoinAmount('150G'),
		"rentPrice": getCoinAmount('50G'),
		"tenants": []
	};
	
	this.exists = function(data) {
		return data.get('region_'+this.name) != null;
	};
	this.load = function(data) {
		if(this.exists(data)) {
			this.regiondata = objMerge(this.regiondata, JSON.parse(data.get('region_'+this.name)));
		}
	};
	this.hasPos = function(name) {
		return Object.keys().indexOf(name) > -1;
	};
	this.addPos = function(name) {
		this.regiondata.positions[name] = {
			x1: null,
			y1: null,
			z1: null,
			x2: null,
			y2: null,
			z2: null,
		};
		return this;
	};
	this.delPos = function(name) {
		if(this.hasPos(name)) {
			
		}
		
		return this;
	}
}function Team(name) {
	this.name = name;
	this.teamdata = {
		"chatcolor": null,
		"chateffect": null,
	};
	this.save = function(data) {
		data.put('team_'+this.name, JSON.stringify(data));
		return this;
	};
	this.exists = function(data) {
		return data.get('team_'+this.name) != null;
	};
	this.remove = function(data) {
		if(this.exists(data)) {
			data.remove('team_'+this.name);
		}
		return this;
	};
	this.teamExists = function(sb) {
		return sb.hasTeam(this.name);
	};
	this.load = function(data, sb) {
		if(this.exists(data)) {
			this.teamdata = JSON.parse(data.get('team_'+this.name));
			return true;
		}
		return false;
	};
}

var _COINTABLE = {
	'c': 1,
	'g': 100,
	'k': 100000,
	'm': 100000000
};

var _COINITEMS = {
	'1c': 'variedcommodities:coin_iron',
	'5c': 'variedcommodities:coin_iron',
	'10c': 'variedcommodities:coin_iron',
	'20c': 'variedcommodities:coin_iron',
	'50c': 'variedcommodities:coin_iron',
	'1g': 'variedcommodities:coin_iron',
	'2g': 'variedcommodities:coin_iron',
	'5g': 'variedcommodities:money',
	'10g': 'variedcommodities:money',
	'20g': 'variedcommodities:money',
	'50g': 'variedcommodities:money',
	'100g': 'variedcommodities:money',
	'200g': 'variedcommodities:money',
	'500g': 'variedcommodities:money',
	'1k': 'variedcommodities:plans',
	'10k': 'variedcommodities:plans',
	'100k': 'variedcommodities:plans',
	'1m': 'variedcommodities:plans',
};


function genMoney(w, amount) {
	var am = amount
	var coinams = Object.keys(_COINITEMS);
	var nmItems = [];
	for(var i = coinams.length-1; i >= 0; i--) {
		var coincount = 0;
		var coinval = getCoinAmount(coinams[i]);
		if(coinval > 0) {
			while(am >= coinval) {
				coincount++;
				am -= coinval;
			}
		}
		if(coincount > 0) {
			var coinitem = w.createItem(_COINITEMS[coinams[i]], 0, coincount);
			coinitem.setCustomName(ccs('&2&lMoney&r'));
			coinitem.setLore([
				ccs('&e'+coinams[i].toUpperCase())
			]);
			nmItems.push(coinitem);
		}
	}
	
	
	return nmItems;
	
}

function getPlayerMessage(player, message, w, pname, fullraw, allowed) {
	if(typeof(pname) == typeof(undefined)) { var pname = null; }
	if(typeof(fullraw) == typeof(undefined)) { var fullraw = true; }
	if(typeof(allowed) == typeof(undefined)) { var allowed = null; }
	if(pname == null) {pname = player.getName();}
	var sb = w.getScoreboard();
	var ts = sb.getTeams();
	var t = sb.getPlayerTeam(pname);
	var notifySound = pick([
		'animania:cluck3',
		'animania:combo',
		'animania:crow3',
		'animania:moo2',
		'animania:ooooohh',
		'animania:reeee',
		'immersiveengineering:birthdayparty',
	]);
	var pcol = '';
	var pteam = '';
	var tcol = '';
	var teff = '';
	var colls = Object.keys(_RAWCOLORS);
	var effs = Object.keys(_RAWEFFECTS);
	if(t != null) {
		var ct = new Team(t.getName());
		if(ct.teamdata.chatcolor != null) {
			if(colls.indexOf(ct.teamdata.chatcolor) > -1) {
				tcol = '&'+getColorId(ct.teamdata.chatcolor);
			}
		}
		if(ct.teamdata.chateffect != null) {
			if(effs.indexOf(ct.teamdata.chateffect) > -1) {
				teff = '&'+getColorId(ct.teamdata.chateffect);
			}
		}
		if(t.getColor() != null) {
			pcol = '&'+getColorId(t.getColor());
		}
		pteam = pcol+"&o"+t.getDisplayName()+" &r"+pcol;
	}
	//var timestr = '';
	//var now = new Date();
	//timestr = '&l[&r'+pcol+now.getHours().toString().append('0', 2)+':'+now.getMinutes().toString().append('0', 2)+'&l]&r';
	
	//var newmsg = pcol+timestr+pcol+'&l[&r'+pteam+pname+'&r'+pcol+'&l] -> &r'+tcol+teff;
	var newmsg = pcol+'&l[&r'+pteam+pname+'&r'+pcol+'&l] -> &r'+tcol+teff;
	if(!fullraw) {
		newmsg = ccs(newmsg);
	}
	newmsg += ccs(message.rangeUpper(0, 1), allowed);
	
	var plr = w.getAllPlayers();
	var mrx = /@(\w+)/g;
	var mplr = newmsg.match(mrx) || [];
	
	for(k in mplr) {
		var mtc = mplr[k].replace(mrx, '$1');
		var pmtc = null;
		for(p in plr) {
			if(occurrences(plr[p].getName().toLowerCase(), mtc.toLowerCase()) > 0) {
				pmtc = plr[p].getName();
				break;
			}
		}
		if(pmtc != null) {
			executeCommand(player, "/playsound "+notifySound+" hostile "+pmtc, pmtc);
			newmsg = ccs(newmsg.replace('@'+mtc, '&9&o&l@'+pmtc+'&r'));
		}
	}
	
	var trx = /#(\w+)/g;
	var tlr = newmsg.match(trx) || [];
	var apl = (function(w){
		var pnames = [];
		var ps = w.getAllPlayers();
		for(psi in ps) {
var iplayr = ps[psi];
			pnames.push(iplayr.getName());
		}
		
		return pnames;
	})(w);
	for(t in tlr) {
		var tc = tlr[t].replace(trx, '$1');
		for(tt in ts) {
var sbt = ts[tt];
			if(occurrences(sbt.getDisplayName().toLowerCase(), tc.toLowerCase()) > 0) {
				//Team select
				var spl = sbt.getPlayers();
				var scol = sbt.getColor();
				var sscol = '&f';
				var stn = sbt.getDisplayName();
				if(scol != null) {
					sscol = "&"+getColorId(scol);
				}
				
				for(sp in spl) {
var splayr = spl[sp];
					if(apl.indexOf(splayr) > -1) {
						executeCommand(player, '/playsound '+notifySound+' hostile '+splayr, splayr);
					}
				}
				newmsg = ccs(newmsg.replace('#'+tc, sscol+'&l'+"#"+stn+'&r'));
			}
		}
	}
	
	return newmsg;
}

function getDropChance(npcnbt, slot) {
	var dropC = npcnbt.getList('DropChance', 10);
	var dropChance = parseInt(dropC[slot].getInteger('Integer'));
	
	
	return dropChance;
}


function getAmountCoin(amount) {
	var rstr = '';
	var ckeys = Object.keys(_COINTABLE);
	for(var i = ckeys.length-1; i >= 0; i--) {
		
		var add = 0;
		while(amount >= _COINTABLE[ckeys[i]]) {
			add++;
			amount -= _COINTABLE[ckeys[i]];
		}
		if(add > 0) {
			rstr += add.toString()+ckeys[i].toUpperCase();
		}
	}
	return rstr;
}

function getCoinAmount(str) {
	var arx = /([\d]+)([a-zA-Z]+)/g;
	var amounts = str.match(arx) || [];
	var amount = 0;
	
	for(a in amounts) {
var _am = amounts[a];
		var _amnum = parseInt(_am.replace(arx, '$1'));
		var _amunit = _am.replace(arx, '$2').toLowerCase();
		var coinkeys = Object.keys(_COINTABLE);
		if(coinkeys.indexOf(_amunit) > -1) {
			amount += _amnum*_COINTABLE[_amunit];
		}
	}
	return amount;
}









function registerXCommand(commandMatch, callback, perm) {
	_COMMANDS.push({
		usage: commandMatch,
		callback: callback,
		perm: perm
	});
}

function getCommandNoArg(cmdstr) {
	return cmdstr.match(/![\w\s]+/)[0];
}

function registerXCommands(cmds) {
	for(c in cmds) {
		registerXCommand(cmds[c][0], cmds[c][1], cmds[c][2]);
	}
}

function parseUsageRgx(command, str) {
	if(typeof(str) == typeof(undefined)) { var str = null; }//Converts command usage to Regex, and gathers info about command
	//!perms\s+manage\s+add((?:\s+[\w]+))((?:\s+[\w]+)*)
	//+ == <...vars> //multiple args, minimal one required
	//* == [...vars] //multiple args, optional
	//  == <var> //arg, required
	//? == [var] // arg, optional
	
	var argrx = [];
	var cmdMatch = command.usage
	.replace(/(\w)\s+(\w)/g, "$1\\s+$2")
	.replace(/(\w|>|\])\s+(\w|<|\[)/g, "$1$2");
	var req_regx = /<([.]{3})*([\w]+)>/g;
	var opt_regx = /\[([.]{3})*([\w]+)\]/g;
	var rm = cmdMatch.allMatch(req_regx);
	for(i in rm) {//required args
		var rmcode = rm[i][0];
		var rmmulti = (rm[i][1] != null);
		var rmname = rm[i][2];
		var rmpart = "((?:\\s+\\S+)"+(rmmulti?"+":"")+")";
		if(str != null) {
			argrx.push([
				command.usage.indexOf(rmcode),
				rmname,
				rmmulti
			]);
		}
		cmdMatch = cmdMatch.replace(rmcode, rmpart);
	}
	var om = cmdMatch.allMatch(opt_regx);
	for(i in om) {//optional args
		var omcode = om[i][0];
		var ommulti = (om[i][1] != null);
		var omname = om[i][2];
		var ompart = "((?:\\s+\\S+)"+(ommulti?"*":"?")+")";
		if(str != null) {
			argrx.push([
				command.usage.indexOf(omcode),
				omname,
				ommulti
			]);
		}
		cmdMatch = cmdMatch.replace(omcode, ompart);
	}
	
	var capt_names = [];
	var cids = [];
	
	while(argrx.length > 0) {
		var hid = 0;
		for(i in argrx)  {
			if(argrx[i][0] > hid) {
				hid = argrx[i][0];
			}
		}
		for(i in argrx)  {
			if(argrx[i][0] == hid) {
				capt_names.push([argrx[i][1], argrx[i][2]]);
				argrx.splice(i, 1);
				break;
			}
		}
	}
	capt_names.reverse();
	return [cmdMatch, capt_names];
}

function executeXCommand(str, player) {
	var data = player.world.getStoreddata();
	var sb = player.world.getScoreboard();
	for(c in _COMMANDS) {
		var cmd = _COMMANDS[c];
		var cmdm = parseUsageRgx(cmd, str);
		
		var argrgx = cmdm[0];
		var rgx = new RegExp(argrgx, 'g');
		if( (str.match(rgx) || []).length == 1) {
			if(str.indexOf(str.match(rgx)[0]) == 0 && str.replace(rgx, '') == '') {
				var argnames = cmdm[1];
				var cg = 1;
				var args = {};
				for(a in argnames) {
					var argname = argnames[a][0];
					var ismulti = argnames[a][1];
					if(typeof(args[argname]) == typeof(undefined)) {
						args[argname] = (ismulti ? [] : null)
					}
					var argval = str.replace(rgx, '$'+cg.toString());
					if(ismulti) {
						args[argname] = argval.split(' ');
						args[argname] = args[argname].filter(function(el){
							return el.toString().length > 0;
						});
					} else {
						args[argname] = (argval.trim() == "" ? null : argval.trim());
					}
					
					
					cg++;
				}
				
				var cmdperm = new Permission(cmd.perm);
				if(!cmdperm.exists(data)) {
					cmdperm.save(data);
				}
				cmdperm.load(data);
				if(cmdperm.permits(player.getName(), sb, data)) {
					return cmd.callback(player, args);
				} else {
					tellPlayer(player, "&cYou don't have permission to this command!");
					return false;
				}
			}
		}
	}
	//No valid command given
	var usg = [];
	var aa = str.split(" ");
	
	while(aa.length > 0) {
		var saa = aa.join(" ");
		if(usg.length == 0) {
			for(c in _COMMANDS) {
var cmd = _COMMANDS[c];
				if(occurrences(cmd.usage, saa) > 0) {
					var lcp = new Permission(cmd.perm);
					lcp.load(data);
					if(lcp.permits(player.getName(), sb, data)) {
						usg.push(cmd.usage);
					}
				}
			}
		}
		aa.splice(-1,1);
	}
	
	if(usg.length > 0) {
		tellPlayer(player, "&eDid you mean:");
		for(u in usg) {
			tellPlayer(player, "&e - &c"+usg[u]+"{suggest_command;"+getCommandNoArg(usg[u])+"}");
		}
	} else {
		tellPlayer(player, "&cCould not find this command!");
	}
	return false;
	
}



//Register commands

	registerXCommands([
		//['', function(pl, args){}, ''],
	]);

	registerXCommands([
		['!renameLore <slot> [...lore]', function(pl, args){
			var mItem = pl.getMainhandItem();
			
			if(!mItem.isEmpty()) {
				var newLoreStr = args.lore.join(' ');
				var newLore = objArray(mItem.getLore());
				var s = parseInt(args.slot) || 0;
				if(s < newLore.length) {
					newLore[s] = ccs(newLoreStr);
				} else {
					newLore.push(ccs(newLoreStr));
				}
				mItem.setLore(newLore);
				tellPlayer(pl, "&aRenamed lore!");
			} else {
				tellPlayer(pl, "&cYou don't have anything in your hand!");
			}
			
			return false;
		}, 'renameLore'],
		['!renameItem <...name>', function(pl, args){
			var mItem = pl.getMainhandItem();
			
			if(!mItem.isEmpty()) {
				var newName = args.name.join(' ');
				mItem.setCustomName(ccs(newName));
				return true;
			} else {
				tellPlayer(pl, "&cYou don't have anything in your hand!");
			}
			
			return false;
		}, 'renameItem'],
	]);

	registerXCommands([
		['!jobs add <name> [...display_name]', function(pl, args){
			var job = new Job(args.name);
			var dname = args.display_name.join(' ');
			var data = pl.world.getStoreddata();
			if(!job.exists(data)) {
				if(dname != "") {
					job.jobdata.displayName = dname;
				}
				tellPlayer(pl, "&aJob '"+job.getDisplayName()+"&a' created!");
				job.save(data);
				return true;
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&c' already exists!");
			}
			return false;
		}, 'jobs.add'],
		['!jobs remove <name>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.remove(data);
				tellPlayer(pl, "&aRemoved job '"+job.getDisplayName()+"&a'!");
				return true;
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&c' does not exists!");
			}
			return false;
		}, 'jobs.add'],
		['!jobs setPay <name> <amount>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				var amount = getCoinAmount(args.amount);
				job.jobdata.pay = amount;
				job.save(data);
				tellPlayer(pl, "&aSet the salary of job '"+job.getDisplayName()+"&a' to "+getAmountCoin(amount)+"!");
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&a' does not exists!");
			}
		}, 'jobs.setPay'],
		['!jobs setPayTime <name> <time>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				var time = getStringTime(args.time);
				job.jobdata.payTime = time;
				job.save(data);
				tellPlayer(pl, "&aSet the paytime of job '"+job.getDisplayName()+"&a' to "+getTimeString(time)+"!");
				return true;
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&a' does not exists!");
			}
			return false;
		}, 'jobs.setPayTime'],
		['!jobs setOpen <name> <open>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(args.open == 'true' || args.open == 'false') {
				if(job.exists(data)) {
					job.load(data);
					
					job.jobdata.isOpen = (args.open == 'true');
					
					job.save(data);
					tellPlayer(pl, "&aSet if job '"+job.getDisplayName()+"&a' is open to "+args.open);
				} else {
					tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&c' does not exists!");
				}
			} else {
				tellPlayer(pl, "&c<open> can only be &ntrue&r&c or &nfalse&r&c!");
			}
		}, 'jobs.setOpen'],
		['!jobs setDisplayName <name> <...display_name>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				
				job.jobdata.displayName = args.display_name.join(' ');
				
				job.save(data);
				tellPlayer(pl, "&aSet the display of job_id '"+job.name+"' to '"+job.getDisplayName()+"&a'!");
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"' does not exists!");
			}
		}, 'jobs.setDisplayName'],
		['!jobs list [...matches]', function(pl, args){
			var data = pl.world.getStoreddata();
			var dkeys = data.getKeys();
			tellPlayer(pl, "&l[=======]&r&6&lGramados Job List&r&l[=======]");
			for(d in dkeys) {
var dkey = dkeys[d];
				if( ( dkey.match(/job_(\w.)/g) || [] ).length > 0 ) {
					var job = new Job(dkey.replace(/job_(\w.)/g, '$1'));
					var isMatch = false;
					args.matches.forEach(function(mt){
						if(occurrences(mt, job.name) > 0 || occurrences(mt, job.getDisplayName()) > 0) {
							isMatch = true;
						}
					});
					
					if(args.matches.length == 0 || isMatch) {
						job.load(data);
						tellPlayer(pl, "&e - &r"+job.getStatusColor(data)+escCcs(job.getDisplayName())+"&r (&9&o"+job.name+"&r)");
					}
					
				}
			}
			return true;
		}, 'jobs.list'],
		['!jobs info <name>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				tellPlayer(pl, "&l[=======]&r&6&lGramados Job Info&r&l[=======]");
				tellPlayer(pl, "&eName: &9&o"+job.name);
				tellPlayer(pl, "&eDisplay Name: &r"+escCcs(job.getDisplayName()));
				tellPlayer(pl, "&eIncome: "+getAmountCoin(job.jobdata.pay)+' per '+getTimeString(job.jobdata.payTime));
				tellPlayer(pl, "&eIs Open: "+(job.jobdata.isOpen ? '&atrue':'&cfalse'));
				tellPlayer(pl, "&ePlaces taken: &c"+job.getPlayers(data).length+"/"+(job.jobdata.capacity > -1 ? job.jobdata.capacity : 'UNLIMITED'));
				tellPlayer(pl, "&eFire Time: &6"+getTimeString(job.jobdata.fireTime));
				return true;
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&c' does not exists!");
			}
			return false;
		}, 'jobs.info'],
		['!jobs playerList <name>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				tellPlayer(pl, "&l[=======] &r&6&lGramados Job Player List &r&l[=======]");
				tellPlayer(pl, "&eJob: &9&o"+args.name);
				var pls = job.getPlayers(data);
				for(p in pls) {
var plr = pls[p];
					tellPlayer(pl, "&e - &r"+plr);
				}
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&a' does not exists!");
			}
		}, 'jobs.playerList'],
		['!jobs addPlayers <name> <...player_names>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.exists(data)) {
				job.load(data);
				for(p in args.player_names) {
var apl = args.player_names[p];
					var apo = new Player(apl);
					if(apo.load(data)) {
						apo.addJob(job.name);
						apo.save(data);
					}
				}
				tellPlayer(pl, "&aAdded "+args.player_names.length+" player(s) to job '"+job.name+"'");
			} else {
				tellPlayer(pl, "&cJob '"+job.getDisplayName()+"&a' does not exists!");
			}
		}, 'jobs.addPlayers'],
		['!jobs setPlaces <name> <amount>', function(pl, args){
			var am = parseInt(args.amount) || 10;
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.load(data)) {
				job.jobdata.capacity = am;
				tellPlayer(pl, "&aSet max players of job '"+job.name+"' to "+am+'!');
				job.save(data);
			} else {
				tellPlayer(pl, "&cJob '"+job.name+"' does not exists!");
			}
		}, 'jobs.setPlaces'],
		['!jobs setFireTime <name> <time>', function(pl, args){
			var time = getStringTime(args.time);
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.load(data)) {
				job.jobdata.fireTime = time;
				tellPlayer(pl, "&aSet fire time of job '"+job.name+"' to "+getTimeString(time)+"!");
				job.save(data);
			} else {
				tellPlayer(pl, "&cJob '"+job.name+"' does not exists!");
			}
		}, 'jobs.setFireTime'],
		['!jobs removePlayers <name> <...players>', function(pl, args){
			var job = new Job(args.name);
			var data = pl.world.getStoreddata();
			if(job.load(data)) {
				for(p in args.players) {
var apl = args.players[p];
					var apo = new Player(apl);
					if(apo.load(data)) {
						apo.delJob(job.name);
						apo.save(data);
					}
				}
				tellPlayer(pl, "&aRemoved "+args.players.length+" player(s) from job '"+job.name+"'");
			} else {
				tellPlayer(pl, "&cJob '"+job.name+"' does not exists!");
			}
		}, 'jobs.removePlayers'],
		['!jobs reload', function(pl, args){
			var data = pl.world.getStoreddata();
			var dkeys = data.getKeys();
			var jc = 0;
			for(d in dkeys) {
var dkey = dkeys[d];
				if(dkey.cmatch(/job_(\w+)/g)) {
					var job = new Job(dkey.replace(/job_(\w+)/g, '$1'));
					if(job.load(data)) {
						job.save(data);
					}
					jc++;
				}
			}
			tellPlayer(pl, "&aReloaded "+jc+" job(s)!");
		}, 'jobs.reload']
	]);

	//REGISTER PERMISSION COMMANDS
	registerXCommands([
		['!perms setEnabled <permission_id> <value>', function(pl, args){
			var perm = new Permission(args.permission_id);
			var data = pl.world.getStoreddata();
			if(perm.exists(data)) {
				if(args.value == 'true' || args.value == 'false') {
					perm.permdata.enabled = (args.value == 'true');
					perm.save(data);
					tellPlayer(pl, "&a"+(args.value == 'true' ? 'Enabled' : 'Disabled')+" permission '"+args.permission_id+"'!");
				} else {
					tellPlayer(pl, "&c<value> must be &ntrue&r&c or &nfalse&r&c!");
				}
			} else {
				tellPlayer(pl, "&c"+args.permission_id+" does not exists!");
			}
		}, 'perms.setEnabled'],
		['!perms addTeams <permission_id> <...teams>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				p.addTeams(args.teams).save(data);
				tellPlayer(pl, "&aAdded teams \""+args.teams.join(", ")+"\" to "+p.id+"!");
				return true;
			} else {
				tellPlayer(pl, "&c"+args.permission_id+" does not exists!");
			}
			return false;
		}, 'perms.addTeams'],
		['!perms removeTeams <permission_id> <...teams>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				p.removeTeams(args.teams).save(data);
				tellPlayer(pl, "&aRemoved teams \""+args.teams.join(", ")+"\" to "+p.id+"!");
				return true;
			} else {
				tellPlayer(pl, "&c"+args.permission_id+" does not exists!");
			}
			return false;
		}, 'perms.removeTeams'],
		['!perms addPlayers <permission_id> <...players>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				p.addPlayers(args.players).save(data);
				tellPlayer(pl, "&aAdded players \""+args.players.join(", ")+"\" to "+p.id+"!");
				return true;
			} else {
				tellPlayer(pl, "&c"+args.permission_id+" does not exists!");
			}
			return false;
		}, 'perms.addPlayers'],
		['!perms removePlayers <permission_id> <...players>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				p.removePlayers(args.players).save(data);
				tellPlayer(pl, "&aRemoved players \""+args.players.join(", ")+"\" to "+p.id+"!");
				return true;
			} else {
				tellPlayer(pl, "&c"+args.permission_id+" does not exists!");
			}
			return false;
		}, 'perms.removePlayers'],
		['!perms remove <permission_id>', function(pl, args){
			var data = pl.world.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				if(p.remove(data)) {
					tellPlayer(pl, "&aRemoved "+p.id+"!");
					return true;
				} else {
					tellPlayer(pl, "&cCould not remove "+p.id+"!");
					return false;
				}
			}
		}, "perms.remove"],
		['!perms add <permission_id>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(!p.exists(data)) {
				tellPlayer(pl, "&aSaved new permission "+p.id);
				p.save(data);
			} else {
				tellPlayer(pl, "&cPermission already exists!");
			}
			
			return true;
		}, 'perms.add'],
		['!perms list [...matches]', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var ids = getAllPermissionIds(data);
			if(ids.length > 0) {
				tellPlayer(pl, "&l<-====- &6&lGramados Permission Ids&r&l -====->");
				for(i in ids) {
var id = ids[i];
					isMatch = false;
					args.matches.forEach(function(el){
						if(occurrences(id, el) > 0) { isMatch = true; }
					});
					if(args.matches.length == 0 || isMatch) {
						tellPlayer(pl, "&e - &9&l"+id);
					}
				}
			} else {
				tellPlayer(pl, "&cThere are no registered permissions");
			}
			return true;
		}, ['perms.list']],
		['!perms info <permission_id>', function(pl, args){
			var w = pl.world;
			var data = w.getStoreddata();
			var p = new Permission(args.permission_id);
			if(p.load(data)) {
				tellPlayer(pl, "&l[=======] &6&lGramados Permission Info&r&l [=======]");
				tellPlayer(pl, "&eID: &9&o"+p.id)
				tellPlayer(pl, "&eEnabled: &r"+(p.permdata.enabled ? '&atrue' : '&cfalse'))
				tellPlayer(pl, "&ePermitted Teams:");
				for(i in p.permdata.teams) {
var team = p.permdata.teams[i];
					tellPlayer(pl, "&e - &r&o"+team);
				}
				tellPlayer(pl, "&ePermitted Players:");
				for(i in p.permdata.players) {
var player = p.permdata.players[i];
					tellPlayer(pl, "&e - &r&o"+player);
				}
			} else {
				tellPlayer(pl, "&cCould not find any info for "+args.permission_id);
			}
		}, 'perms.info']
	]);

	//REGISTER PLAYER COMMANDS
	registerXCommands([
		//PLAYER MANAGE
		['!player setPay <player> <amount>', function(pl, args){
			var am = getCoinAmount(args.amount);
			var p = new Player(args.player);
			var data = pl.world.getStoreddata();
			
			p.load(data);
			p.playerdata.pay = am;
			p.save(data);
			tellPlayer(pl, "&aSet pay amount of player '"+p.name+"' to "+getAmountCoin(am)+'!');
		
			return true;
		}, 'player.setPay'],
		['!player setPayTime <player> <time>', function(pl, args){
			var am = getStringTime(args.time);
			var p = new Player(args.player);
			var data = pl.world.getStoreddata();
			
			p.load(data);
			p.playerdata.payTime = am;
			p.save(data);
			tellPlayer(pl, "&aSet pay time of player '"+p.name+"' to "+getTimeString(am)+'!');
		
			return true;
		}, 'player.setPayTime'],
		['!player setMaxJobs <player> <amount>', function(pl, args){
			var p = new Player(args.player);
			var data = pl.world.getStoreddata();
			
			p.load(data);
			p.playerdata.maxJobs = parseInt(args.amount) || 1;
			p.save(data);
			
			tellPlayer(pl, "&aSet maxhomes of player '"+p.name+"' to "+(parseInt(args.amount) || 1)+'!');
			return true;
		
		}, 'player.setMaxJobs'],		
		['!player setMaxHomes <player> <amount>', function(pl, args){
			var p = new Player(args.player);
			var data = pl.world.getStoreddata();
			
			p.load(data);
			p.playerdata.maxHomes = parseInt(args.amount) || 1;
			p.save(data);
			
			tellPlayer(pl, "&aSet maxhomes of player '"+p.name+"' to "+(parseInt(args.amount) || 1)+'!');
			return true;
		
		}, 'player.setMaxHomes'],
		
		//PLAYER UTILITY
		['!myIncome', function(pl, args){
			var p = new Player(pl.getName());
			var data = pl.world.getStoreddata();
			p.load(data);
			tellPlayer(pl, "&l[=======] &r&6&lGramados Income&r &l[=======]");
			tellPlayer(pl, "&eBasic income: "+getAmountCoin(p.playerdata.pay)+" per "+getTimeString(p.playerdata.payTime));
			var tleft = (p.playerdata.lastPayed+p.playerdata.payTime) - new Date().getTime();
			tellPlayer(pl, "&e"+getTimeString(tleft, ['ms'])+" until next pay.");
			var pjobs = p.getJobs(data);
			
			if(pjobs.length > 0) {
				if(!p.hasMaxJobs() && p.playerdata.maxJobs) {
					
				}
				
				for(pj in pjobs) {
var pjob = pjobs[pj];
					
				}
			}
			
			
			//print(p.toJson());
			return true;
			
		}, 'myIncome'],
		['!setHome <name>', function(pl, args){
			var plo = new Player(pl.getName());
			var data = pl.world.getStoreddata();
			var ppos = pl.getPos();
			plo.load(data);
			if(plo.hasHome(args.name)) {//edit existing home
				plo.setHome(args.name, ppos.getX(), ppos.getY(), ppos.getZ());
			} else {//Add new home
				if(plo.playerdata.maxHomes == -1 || Object.keys(plo.playerdata.homes).length < plo.playerdata.maxHomes) {
					plo.addHome(args.name, ppos.getX(), ppos.getY(), ppos.getZ());
					tellPlayer(pl, "&aAdded home '"+args.name+"'!");
					plo.save(data);
					return true;
				} else {
					tellPlayer(pl, "&cYou have reached maximum amount of homes! ("+plo.playerdata.maxHomes+")");
				}
			}
			return false;
		}, 'setHome'],
		['!delHome <name>', function(pl, args){
			var plo = new Player(pl.getName());
			var data = pl.world.getStoreddata();
			var ppos = pl.getPos();
			plo.load(data);
			if(plo.hasHome(args.name)) {//remove home
				plo.delHome(args.name);
				tellPlayer(pl, "&aRemoved home '"+args.name+"'!");
				plo.save(data);
				return true;
			} else {//Add new home
				tellPlayer(pl, "&cHome '"+args.name+"' does not exist!");
			}
			return false;
		}, 'delHome'],
		['!listHomes', function(pl, args){
			var plo = new Player(pl.getName());
			var data = pl.world.getStoreddata();
			plo.load(data);
			if(Object.keys(plo.playerdata.homes).length > 0) {
				tellPlayer(pl, "&l[=======] &6&lGramados Homes &r&l[=======]");
				for(i in plo.playerdata.homes) {
var home = plo.playerdata.homes[i];
					tellPlayer(pl, "&e - &9&o"+i+"&r&e (X: &c"+home.x+"&e,Y: &c"+home.y+"&e,Z: &c"+home.z+"&e)&r");
				}
				return true;
			} else {
				tellPlayer(pl, "&cYou don't have any homes!");
			}
			
			return false;
		}, 'listHomes'],
		['!home <name>', function(pl, args){
			var plo = new Player(pl.getName());
			var data = pl.world.getStoreddata();
			var ppos = pl.getPos();
			plo.load(data);
			if(plo.hasHome(args.name)) {
				var h = plo.playerdata.homes[args.name];
				pl.setPosition(h.x, h.y, h.z);
			} else {
				tellPlayer(pl, "&cHome '"+args.name+"' does not exist!");
			}
			return false;
		}, 'home']
	]);

	//REGISTER TEAM COMMANDS
	registerXCommands([
		['!teams set chatcolor <team_name> [color]', function(pl, args){
			var w = pl.world;
			var sb = w.getScoreboard();
			var t = new Team(args.team_name);
			var data = w.getStoreddata();
			if(t.teamExists(sb)) {
				if(args.color != null) {
					args.color = args.color.toLowerCase();
				}
				var acols = objArray(_RAWCOLORS);
				if(acols.indexOf(args.color) > -1) {
					t.teamdata.chatcolor = args.color;
					t.save(data);
					tellPlayer(pl, "&aSet chatcolor for team ");
				} else {
					tellPlayer(pl, "&c'"+args.color+"' is not a valid value. Use one of the following: &o"+acols.join(', '));
				}
				
			} else {
				tellPlayer(pl, "&cTeam '"+args.teamname+"' does not exist!");
				t.remove(data);
			}
		}, 'teams.set.chatcolor']
	]);

	//REGISTER UTIL COMMANDS
	registerXCommands([
		['!tellraw <player> <...message>', function(pl, args){
			var msg = args.message.join(' ');
			print(executeCommand(pl, '/tellraw '+args.player+' '+strf(msg, true)));
			return true;
		}, 'tellraw'],
		['!setMagAmmo <amount>', function(pl, args){
			var mItem = pl.getMainhandItem();
			var am = parseInt(args.amount) || 0;
			if(!mItem.isEmpty()) {
				var mnbt = mItem.getNbt();
				if(mnbt.has('Ammo')) {
					mnbt.setInteger('Ammo', am);
					//Item.setNbt(mnbt);
					tellPlayer(pl, "&aSet ammo to "+am+"!");
					return true;
				}
			}
			tellPlayer(pl, "&cYou don't have an magazine in your hand!");
			
			return false;
		}, 'setMagAmmo'],
		['!convertNpcLoot <radius>', function(pl, args){
			var w = pl.world;
			var ents = w.getNearbyEntities(pl.getPos(), parseInt(args.radius) || 4, 2);
			for(ee in ents) {
var ent = ents[ee];
				if(ent.getType() == 2) {//Is NPC
					var entnbt = ent.getEntityNbt();
					var entinv = ent.getInventory();
					for(var i = 0; i < 9; i++) {
						var dc = getDropChance(entnbt, i);
						var di = entinv.getDropItem(i);
						if(di != null) {
							var diLore = di.getLore();
							if(diLore.length > 0) {
								var diAmount = getCoinAmount(diLore[0].replace(/\s+/g, ''));
								if(diAmount > 0) {
									di.setCustomName(ccs("&2&lMoney&r"));
									di.setLore([ccs('&e'+getAmountCoin(diAmount))]);
									
									entinv.setDropItem(i, di, dc);
								}
							}
						}
					}
				}
			}
			tellPlayer(pl, "&aAffected "+ents.length+" entities.");
			return true;
		}, 'convertNpcLoot'],
		['!convertTrader <amount>', function(pl, args){
			var amount = parseInt(args.amount) || null;
			var ppos = pl.getPos();
			if(amount != null) {
				if(amount >= 4 && amount <= 32) {
					var ents = pl.world.getNearbyEntities(ppos, amount, 2);
					for(en in ents) {
var ent = ents[en];
						print(ent.getPos().normalize());
						if(ent.getType() == 2) {//Is NPC
							var entrole = ent.getRole();
							if(entrole != null) {
								if(entrole.getType() == 1) {//Is Trader
									//Loop sellItems
									var newTrades = [];
									for(var i = 0; i < 18; i++) {
										var newTrade = [
											entrole.getCurrency1(i),
											entrole.getCurrency2(i),
											entrole.getSold(i),
										];
										
										entrole.remove(i);
									}
									for(var i = 0; i < 18; i++) {
										print('SLOT: '+i);
										
										
										for(ii in newTrade) {
var nItem = newTrade[ii];
											if(!nItem.isEmpty()) {
												var nLore = nItem.getLore();
												if(nLore.length > 0) {
													var nAmount = getCoinAmount(nLore[0].replace(/\s+/g, ''));
													if(nAmount > 0) {
														nItem.setCustomName(ccs('&2&lMoney&r'));
														nItem.setLore([ccs('&e'+getAmountCoin(nAmount))]);
													}
												}
											}
											newTrade[ii] = nItem;
										}
										newTrade.forEach(function(nt){
											print(nt.getItemNbt().toJsonString());
										});
										entrole.set(
											i,
											newTrade[0].isEmpty() ? null : newTrade[0],
											newTrade[1].isEmpty() ? null : newTrade[1],
											newTrade[2].isEmpty() ? null : newTrade[2]
										);
									}
									
								}
							}
						}
					}
					if(ents.length == 0) {
						tellPlayer(pl, "&cNo NPC Traders found in a radius of "+amount+" blocks.");
					}
				} else {
					tellPlayer(pl, "&cYou have a minimum of 4 blocks and a maximum of 32 block!");
				}
			} else {
				tellPlayer(pl, "&c<amount> is not a valid number!");
			}
			return false;
		}, 'convertTrader'],
		['!convertMoney', function(pl, args){
			var mItem = pl.getMainhandItem();
			if(!mItem.isEmpty()) {
				var mL = mItem.getLore();
				if(mL.length > 0) {
					var cAm = getCoinAmount(mL[0].replace(/\s/g, ''));
					if(cAm > 0) {
						mItem.setCustomName(ccs('&2&lMoney&r'));
						mItem.setLore([
							ccs('&e'+getAmountCoin(cAm))
						]);
						tellPlayer(pl, "&aConverted money!");
						return true;
					}
				}
				tellPlayer(pl, "&cYou don't have valid money in hand!");
			} else {
				tellPlayer(pl, "&cYou don't have anything in your hand!");
			}
			
			return false;
		}, 'convertMoney'],
		['!giveMoney <amount> [...players]', function(pl, args){
			var w = pl.world;
			var plrs = [];
			objArray(w.getAllPlayers()).forEach(function(wp){
				plrs.push(wp.getName());
			});
			var am = getCoinAmount(args.amount);
			if(args.players.length == 0) { args.players = [pl.getName()]; }
			var mn = genMoney(w, am);
			
			for(i in args.players) {
var apl = args.players[i];
				if(plrs.indexOf(apl) > -1) {
					for(m in mn) {
var mi = mn[m];
						w.getPlayer(apl).giveItem(mi);
					}
				}
			}
			
			tellPlayer(pl, "&aGave "+getAmountCoin(am)+" to players: '"+args.players.join(', ')+"'");
			
			return true;
			
		}, 'giveMoney'],
		['!sayas <player> <...message>', function(pl, args){
			var w = pl.world;
			var ap = args.player;
			var msg = args.message.join(" ");
			var nmsg = getPlayerMessage(pl, msg, w, ap, false);
			w.broadcast(nmsg);
			return true;
			
		}, 'sayas'],
	]);



/*
Bridge between Reskillable-Compatskills mod and Custom NPCs
*/

var _SKILLS = [
	/*'compatskills.archery',
	'compatskills.trading',
	'compatskills.woodcutting',
	'compatskills.enchanting',*/
	'reskillable.attack',
	'reskillable.defense',
	'reskillable.farming',
	'reskillable.magic',
	'reskillable.mining',
	'reskillable.agility',
	'reskillable.building',
	'reskillable.gathering',
];

var _TRAITS = [
	//'compatskills.rename_tag',
	//'compatskills.more_deals',
];

//add xp objectives
var xp_stats = [];
var skill_names = [];
for(s in _SKILLS) {
	xp_stats[s] = _SKILLS[s].replace(/[\w]+\.([\w]+)/g, "$1_xp"); //Converts 'reskillable.mining' to 'mining_xp'
	skill_names[s] = _SKILLS[s].replace(/[\w]+\.([\w]+)/g, "$1").rangeUpper(0,1); //Converts 'reskillable.mining' to 'Mining'
}

function getXpStatFromSkill(skill_id) {
	return skill_id.replace(/[\w]+\.([\w]+)/g, "$1_xp");
}


function getSkillNameFromSkill(skill_id) {
	return skill_id.replace(/[\w]+\.([\w]+)/g, "$1").rangeUpper(0, 1);
}

function getRawSkillString(skillname, level, xp) {
	var skn = [];
	var pxp = xp;
	var mxp = getMaxXp(level);
	if(level < 99) {
		var pcol = 'red';
		var xpprog = Math.round(100/mxp*pxp);
		
		if(xpprog >= 75) {
			pcol = 'blue';
		} else if(xpprog >= 50) {
			pcol = 'green';
		} else if(xpprog >= 25) {
			pcol = 'gold';
		}
		
		skn.push([skillname, 'blue', 0, 1]);
		skn.push([' - Level: ', 'yellow', 0, 1]);
		skn.push([level.toString()+' ', 'red']);
		skn.push(['- XP: ', 'yellow', 0, 1]);
		skn.push([pxp.toString()+'/'+mxp.toString()+' ', pcol, 0, 0]);
		skn.push([' [', 'white']);
		
		var progdone = '';
		var progtodo = '';
		
		for(var j = 0; j < Math.round(20/100*xpprog); j++) {
			progdone += '|';
		}
		
		for(var j = 0; j < Math.round(20/100*(100-xpprog)); j++) {
			progtodo += '|';
		}
		
		skn.push([progdone, 'green']);
		skn.push([progtodo, 'red']);
		skn.push(['] ', 'white']);
		//skn.push(['- Progress: ', 'yellow', 0, 1]);
		skn.push([xpprog.toString()+'%', pcol, 0, 1]);
	} else {
		skn.push([skillname, 'blue', 0, 1]);
		skn.push([' - Max Level (Total XP: ', 'green', 0, 1]);
		skn.push([pxp.toString(), 'gold', 0, 1]);
		skn.push([')', 'green', 0, 1]);
	}
	return skn;
}

function hasTraits(player, traits) {
	
	if(typeof(traits) == 'string') { traits = [traits]; }
	var s = getSkills(player, null, traits);
	var t = 0;
	for(k in s) {
		var skill = s[k];
		for(u in skill.unlockables) {
			if(traits.indexOf(skill.unlockables[u]) > -1) {
				t++;
			}
		}
	}
	
	return t == traits.length;
}


function getMaxXp(lvl) {
	return 10+(Math.max(lvl-1, 0)*(2*Math.max(lvl, 1)));
}

function getSkillArray(player, skills, traits) {
	if(typeof(skills) == typeof(undefined)) { var skills = null; }
	if(typeof(traits) == typeof(undefined)) { var traits = null; }
	var s = getSkills(player, skills, traits);
	var a = [];
	for(n in s) { a.push(n); }
	return a;
}

function getSkills(player, skills, traits) {
	if(typeof(skills) == typeof(undefined)) { var skills = null; }
	if(typeof(traits) == typeof(undefined)) { var traits = null; }
	
	if(skills == null) {
		skills = _SKILLS;
	}
	if(traits == null) {
		traits = _TRAITS;
	}
	var pskills = {};
	var nbt = player.getNbt();
	var w = player.world;
	var sb = w.getScoreboard();
	var pp = nbt.getCompound('PlayerPersisted');
	var sk = pp.getCompound('SkillableData').getCompound('SkillLevels');
	for(k in skills) {
		var skill = sk.getCompound(skills[k]);
		var unlocks = [];
		var unl = skill.getCompound('unlockables');
		var sxp = 0;
		var sxp_obj = sb.getObjective(getXpStatFromSkill(skills[k]));
		if(sxp_obj != null) {
			var sxp_sc = sxp_obj.getScore(player.getName());
			if(sxp_sc != null) {
				sxp = sxp_sc.getValue();
			}
		}
		for(u in traits) {
			if(parseInt(unl.getByte(traits[u])) == 1) {
				unlocks.push(traits[u]);
			}
		}
		
		pskills[skills[k]] = {
			id: skills[k],
			level: skill.getInteger('level'),
			xp: sxp,
			skillPoints: skill.getInteger('skillPoints'),
			unlockables: unlocks
		};
		//print(skills[k]+': '+pskills[skills[k]].level.toString());
	}
	
	return pskills;
}



function init(e) {
	
	
	//GEN PLAYER PERMISSIONS
	(function(e){
		var w = e.player.world;
		var data = w.getStoreddata();
		var playerperms = [
			"chat",
			"chat.color",
		];
		for(i in _RAWCOLORS) {
var rawc = _RAWCOLORS[i];
			playerperms.push('chat.color.'+rawc);
		}
		for(i in _RAWEFFECTS) {
var rawc = _RAWEFFECTS[i];
			playerperms.push('chat.color.'+rawc);
		}
		//Register if not exists
		for(p in playerperms) {
var plperm = playerperms[p];
			var pperm = new Permission(plperm);
			if(!pperm.exists(data)) {
				pperm.save(data);
			}
		}
		
	})(e);
	
	//END GEN PLAYER PERMISSIONS

	(function(e){
		var pl = e.player;
		var plo = new Player(pl.getName());
		var data = pl.world.getStoreddata();
		
		if(!plo.exists(data)) {
			plo.save(data);
		}
	})(e);


	var w = e.player.world;
	var sb = w.getScoreboard();
	var t = sb.getPlayerTeam(e.player.getName());
	if(t == null && sb.hasTeam('Player')) {
		sb.getTeam('Player').addPlayer(e.player.getName());
	}
}


function interact(e) {
	
	(function(e){
		//Create a 'build'-event for player scripts
		if(e.type == 2) {
			var place_block = e.player.getMainhandItem();
			if( (place_block == null ? true : !place_block.isBlock()) ) { //If placeblock is null or not a block at all
				place_block = e.player.getOffhandItem(); //Try the offhand item
			}
			if( !(place_block == null ? true : !place_block.isBlock()) ) { //Is place_block not null and is a block?
				//Build event can be executed, check if it exists though
				if(typeof(build) != typeof(undefined)) {
					build(e, place_block);
				}
			}
		}
	})(e);

}

function keyPressed(e) {
	
}

function build(e, placeblock) { //Custom event
	
}

function kill(e) {
	
}

function login(e) {
	
}

function logout(e) {
	
}

function pickedUp(e) {
	
}

function rangedLaunched(e) {
	
}

function timer(e) {
	
}

function toss(e) {
	
}

function tick(e) {
	
	
	//CHECK MONEY PAY
	(function(e){
		var pl = e.player;
		var plo = new Player(pl.getName());
		var data = pl.world.getStoreddata();
		plo.load(data);
		
		if(new Date().getTime() > (plo.playerdata.lastPayed+plo.playerdata.payTime)) {
			if(plo.playerdata.pay > 0) {
				var pm = genMoney(pl.world, plo.playerdata.pay);
				for(p in pm) {
var pii = pm[p];
					pl.giveItem(pii);
				}
				tellPlayer(pl, "&aYou have earned "+getAmountCoin(plo.playerdata.pay)+"!");
				plo.playerdata.lastPayed = new Date().getTime();
				plo.save(data);
			}
		}
		
		//CHECK JOB PAY
		for(j in plo.playerdata.jobs) {
var pjob = plo.playerdata.jobs[j];
			var job = new Job(j);
			if(!job.exists(data)) {
				plo.delJob(j);
				plo.save(data);
				continue;
			}
			job.load(data);
			var jobpay = job.jobdata.pay;
			var jobpayTime = job.jobdata.payTime;
			var joblastPayed = pjob.lastPayed;
			var now = new Date().getTime();
			if(now >= joblastPayed+jobpayTime) {
				var pm = genMoney(pl.world, jobpay);
				for(p in pm) {
var pii = pm[p];
					pl.giveItem(pii);
				}
				tellPlayer(pl, "&aYou have earned "+getAmountCoin(jobpay)+" from job '"+job.getDisplayName()+"'&r&a!");
				plo.playerdata.jobs[j].lastPayed = now;
				plo.save(data);
			}
		}
		
		
	})(e);


}

function attack(e) {
	
}

function broken(e) {
	
}

function chat(e) {
	
	if(e.message.substr(0, 1) == '!') {
		executeXCommand(e.message, e.player);
		e.setCanceled(true);
	}

	var w = e.player.world;
	var newmsg = getPlayerMessage(e.player, e.message, w, e.player.getName(), false);
	
	e.message = newmsg;
}

function containerOpen(e) {
	
	print('Opened');
}

function containerClose(e) {
	
}

function damaged(e) {
	
}

function died(e) {
	
}

function factionUpdate(e) {
	
}